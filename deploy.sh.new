#!/bin/bash

set -e

DOCKER_USERNAME=${DOCKER_USERNAME:-"xanderbilla"}
VERSION_FILE="version.txt"
STACK_NAME="devops-stack"
COMPOSE_FILE="docker-compose.yml"

# Function to check if Docker is running
check_docker() {
    if ! docker info > /dev/null 2>&1; then
        echo "❌ Docker is not running. Please start Docker and try again."
        exit 1
    fi
}

# Function to initialize swarm if not already initialized
init_swarm() {
    if ! docker info 2>/dev/null | grep -q "Swarm: active"; then
        echo "🔄 Initializing Docker Swarm..."
        docker swarm init || {
            echo "❌ Failed to initialize Docker Swarm"
            exit 1
        }
        echo "✅ Docker Swarm initialized successfully"
    else
        echo "✅ Docker Swarm is already active"
    fi
}

# Determine version/tag
if [ -f "$VERSION_FILE" ]; then
    IMAGE_TAG=$(cat "$VERSION_FILE")
else
    echo "⚠️ Version file not found. Using 'latest' tag."
    IMAGE_TAG="latest"
fi

# Check if compose file exists
if [ ! -f "$COMPOSE_FILE" ]; then
    echo "❌ Docker Compose file not found: $COMPOSE_FILE"
    exit 1
fi

export DOCKER_USERNAME
export IMAGE_TAG

echo "🚀 Starting deployment process..."
echo "�� Stack name: $STACK_NAME"
echo "🏷️  Image tag: $IMAGE_TAG"
echo "�� Docker username: $DOCKER_USERNAME"

# Check Docker and initialize swarm
check_docker
init_swarm

# Remove existing stack if it exists
if docker stack ls | grep -q "$STACK_NAME"; then
    echo "🔄 Removing existing stack..."
    docker stack rm "$STACK_NAME"
    # Wait for stack removal to complete
    while docker stack ls | grep -q "$STACK_NAME"; do
        echo "⏳ Waiting for stack removal to complete..."
        sleep 2
    done
fi

# Deploy the stack
echo "🚀 Deploying stack '$STACK_NAME'..."
docker stack deploy -c "$COMPOSE_FILE" "$STACK_NAME" || {
    echo "❌ Failed to deploy stack"
    exit 1
}

# Wait for services to be ready
echo "⏳ Waiting for services to be ready..."
sleep 5

# Check service status
echo "📊 Checking service status..."
docker stack services "$STACK_NAME"

echo "✅ Deployment complete!"
echo "🔍 You can check service logs using: docker service logs $STACK_NAME_<service-name>"
